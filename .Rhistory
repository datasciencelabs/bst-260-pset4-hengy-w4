get = "POP_2020,POP_2021,NAME",
`for` = "state:*",
key = census_key
)
request
# <httr2_request>
# GET https://api.census.gov/data/2021/pep/population?get=POP_2020%2CPOP_2021%2CNAME&for=state%3A%2A&key=09e560e2345990d79e92cf06a9a99288a8f910af
# Body: empty
# Looks correct: %2C = , %3A = : %2A = *
?req_perform
# Make the request and store the response
response <- req_perform(request)
# Check status code (200 = OK)
status <- resp_status(response)
if (status != 200) {
stop(paste("Request failed with status", status))
} else {
message("Success: status ", status)
}
resp_content_type(response)
?resp_body_json
population <- resp_body_json(response, simplifyVector = TRUE, simplifyDataFrame = FALSE, simplifyMatrix = TRUE)
library(tidyverse)
library(janitor)
head(population)
?janitor
population <- population |>
as.data.frame(stringsAsFactors = FALSE) |>
janitor::row_to_names(1) |>      # first row -> header
janitor::clean_names() |>
as_tibble() |>
select(-state) |>                # drop state FIPS ID
rename(state_name = name) |>
mutate(
pop_2020 = as.numeric(pop_2020),
pop_2021 = as.numeric(pop_2021),
state = case_when(
state_name == "District of Columbia" ~ "DC",
state_name == "Puerto Rico" ~ "PR",
TRUE ~ state.abb[match(state_name, state.name)]
)
) |>
relocate(state, state_name, pop_2020, pop_2021)
head(population)
library(tidyr)
#| fig.height: 16
#| fig.width: 8
population |>
dplyr::select(state_name, pop_2020, pop_2021) |>
tidyr::pivot_longer(c(pop_2020, pop_2021),
names_to = "year", values_to = "population") |>
dplyr::mutate(year = as.integer(sub("^pop_", "", year))) |>
dplyr::group_by(year) |>
dplyr::mutate(state_order = reorder(state_name, population)) |>
dplyr::ungroup() |>
ggplot2::ggplot(ggplot2::aes(x = state_order, y = population)) +
ggplot2::geom_col() +
ggplot2::coord_flip() +
ggplot2::facet_wrap(~ year, ncol = 1, scales = "free_y") +
ggplot2::scale_y_continuous(labels = scales::label_comma()) +
ggplot2::labs(
title = "State Populations, 2020 vs 2021",
x = "State", y = "Population",
caption = "Source: US Census PEP"
) +
ggplot2::theme(axis.text.y = element_text(size=5),
axis.text.x = element_text(angle = 30, hjust = 1))
library(tidyr)
population |>
dplyr::select(state_name, pop_2020, pop_2021) |>
tidyr::pivot_longer(c(pop_2020, pop_2021),
names_to = "year", values_to = "population") |>
dplyr::mutate(year = as.integer(sub("^pop_", "", year))) |>
dplyr::group_by(year) |>
dplyr::mutate(state_order = reorder(state_name, population)) |>
dplyr::ungroup() |>
ggplot2::ggplot(ggplot2::aes(x = state_order, y = population)) +
ggplot2::geom_col() +
ggplot2::coord_flip() +
ggplot2::facet_wrap(~ year, ncol = 1, scales = "free_y") +
ggplot2::scale_y_continuous(labels = scales::label_comma()) +
ggplot2::labs(
title = "State Populations, 2020 vs 2021",
x = "State", y = "Population",
caption = "Source: US Census PEP"
) +
ggplot2::theme(axis.text.y = element_text(size=5),
axis.text.x = element_text(angle = 30, hjust = 1))
library(tidyr)
population |>
dplyr::select(state_name, pop_2020, pop_2021) |>
tidyr::pivot_longer(c(pop_2020, pop_2021),
names_to = "year", values_to = "population") |>
dplyr::mutate(year = as.integer(sub("^pop_", "", year))) |>
dplyr::group_by(year) |>
dplyr::mutate(state_order = reorder(state_name, population)) |>
dplyr::ungroup() |>
ggplot2::ggplot(ggplot2::aes(x = state_order, y = population)) +
ggplot2::geom_col() +
ggplot2::coord_flip() +
ggplot2::facet_wrap(~ year) +
ggplot2::scale_y_continuous(labels = scales::label_comma()) +
ggplot2::labs(
title = "State Populations, 2020 vs 2021",
x = "State", y = "Population",
caption = "Source: US Census PEP"
) +
ggplot2::theme(axis.text.y = element_text(size=5),
axis.text.x = element_text(angle = 30, hjust = 1))
pkgs <- c(
"httr2",     # HTTP requests and API interactions
"tidyverse", # Data manipulation, visualization, and analysis
"janitor",   # Data cleaning and formatting
"jsonlite",  # JSON data parsing
"lubridate"  # Date and time manipulation
)
to_install <- setdiff(pkgs, rownames(installed.packages()))
if (length(to_install)) {
install.packages(to_install, dependencies = TRUE)
}
invisible(lapply(pkgs, require, character.only = TRUE))
source("census_key.R")
url <- "https://api.census.gov/data/2021/pep/population"
#| message: false
#| warning: false
library(httr2)
?request()
?req_url_query
request <- request(url) |>
req_url_query(
get = "POP_2020,POP_2021,NAME",
`for` = "state:*",
key = census_key
)
request
# <httr2_request>
# GET https://api.census.gov/data/2021/pep/population?get=POP_2020%2CPOP_2021%2CNAME&for=state%3A%2A&key=09e560e2345990d79e92cf06a9a99288a8f910af
# Body: empty
# Looks correct: %2C = , %3A = : %2A = *
?req_perform
# Make the request and store the response
response <- req_perform(request)
# Check status code (200 = OK)
status <- resp_status(response)
if (status != 200) {
stop(paste("Request failed with status", status))
} else {
message("Success: status ", status)
}
resp_content_type(response)
?resp_body_json
population <- resp_body_json(response, simplifyVector = TRUE, simplifyDataFrame = FALSE, simplifyMatrix = TRUE)
library(tidyverse)
library(janitor)
head(population)
?janitor
population <- population |>
as.data.frame(stringsAsFactors = FALSE) |>
janitor::row_to_names(1) |>      # first row -> header
janitor::clean_names() |>
as_tibble() |>
select(-state) |>                # drop state FIPS ID
rename(state_name = name) |>
mutate(
pop_2020 = as.numeric(pop_2020),
pop_2021 = as.numeric(pop_2021),
state = case_when(
state_name == "District of Columbia" ~ "DC",
state_name == "Puerto Rico" ~ "PR",
TRUE ~ state.abb[match(state_name, state.name)]
)
) |>
relocate(state, state_name, pop_2020, pop_2021)
head(population)
library(tidyr)
population |>
dplyr::select(state_name, pop_2020, pop_2021) |>
tidyr::pivot_longer(c(pop_2020, pop_2021),
names_to = "year", values_to = "population") |>
dplyr::mutate(year = as.integer(sub("^pop_", "", year))) |>
dplyr::group_by(year) |>
dplyr::mutate(state_order = reorder(state_name, population)) |>
dplyr::ungroup() |>
ggplot2::ggplot(ggplot2::aes(x = state_order, y = population)) +
ggplot2::geom_col() +
ggplot2::coord_flip() +
ggplot2::facet_wrap(~ year) +
ggplot2::scale_y_continuous(labels = scales::label_comma()) +
ggplot2::labs(
title = "State Populations, 2020 vs 2021",
x = "State", y = "Population",
caption = "Source: US Census PEP"
) +
ggplot2::theme(axis.text.y = element_text(size=5),
axis.text.x = element_text(angle = 30, hjust = 1))
url <- "https://github.com/datasciencelabs/2025/raw/refs/heads/main/data/regions.json"
library(jsonlite)
library(purrr)
url <- "https://github.com/datasciencelabs/2025/raw/refs/heads/main/data/regions.json"
# regions <- use jsonlit JSON parser
# regions <- convert list to data frame. You can use map_df in purrr package
regions <- jsonlite::fromJSON(url, simplifyVector = FALSE) |>
purrr::map_dfr(~ tibble(
region      = as.integer(.x$region[[1]]),
region_name = as.character(.x$region_name),
state_name  = unlist(.x$states, use.names = FALSE)
)) |>
dplyr::mutate(region_name = dplyr::if_else(region == 2, "NY–NJ–PR–VI", region_name)) |>
dplyr::filter(state_name %in% c(state.name, "District of Columbia", "Puerto Rico")) |>
dplyr::arrange(region, state_name)
table(regions$region_name)
population <- population |>
dplyr::left_join(regions, by = "state_name")
head(population)
head(cases_raw)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
# Make the request
resp <- request(api) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform()
# Check status/content
stopifnot(resp_status(resp) == 200,
grepl("json", resp_content_type(resp), ignore.case = TRUE))
# Parse to a data frame
cases_raw <- resp_body_json(resp, simplifyVector = TRUE) |> as_tibble()
dim(cases_raw)
names(cases_raw)
head(cases_raw, 3)
head(cases_raw)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
cases_raw <- request(api) |>
req_url_query(`$limit` = 1000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform() |>
resp_check_status() |>
resp_body_json(simplifyVector = TRUE) |>
tibble::as_tibble() |>
dplyr::transmute(
state = purrr::reduce(dplyr::pick(dplyr::any_of(c("state","state_name","jurisdiction"))), dplyr::coalesce),
date  = as.Date(purrr::reduce(dplyr::pick(dplyr::any_of(c("end_date","submission_date","date","as_of"))), dplyr::coalesce)),
cases = suppressWarnings(as.numeric(purrr::reduce(dplyr::pick(dplyr::any_of(c("cases","tot_cases","total_cases","new_case"))), dplyr::coalesce)))
) |>
dplyr::arrange(state, date)
head(cases_raw)
cases_raw <- request(api) |>  req_url_query(`$limit` =10000000000) |>
↪ req_perform() |> resp_body_json(simplifyDataFrame = TRUE)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
cases_raw <- request(api) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform() |>
resp_check_status() |>
resp_body_json(simplifyVector = TRUE) |>
tibble::as_tibble() |>
dplyr::transmute(
state = purrr::reduce(dplyr::pick(dplyr::any_of(c("state","state_name","jurisdiction"))), dplyr::coalesce),
date  = as.Date(purrr::reduce(dplyr::pick(dplyr::any_of(c("end_date","submission_date","date","as_of"))), dplyr::coalesce)),
cases = suppressWarnings(as.numeric(purrr::reduce(dplyr::pick(dplyr::any_of(c("cases","tot_cases","total_cases","new_case"))), dplyr::coalesce)))
) |>
dplyr::arrange(state, date)
head(cases_raw)
head(cases)
head(cases)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
cases_raw <- request(api) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform() |>
resp_check_status() |>
resp_body_json(simplifyVector = TRUE) |>
tibble::as_tibble() |>
dplyr::transmute(
state = purrr::reduce(dplyr::pick(dplyr::any_of(c("state","state_name","jurisdiction"))), dplyr::coalesce),
date  = as.Date(purrr::reduce(dplyr::pick(dplyr::any_of(c("end_date","submission_date","date","as_of"))), dplyr::coalesce)),
cases = suppressWarnings(as.numeric(purrr::reduce(dplyr::pick(dplyr::any_of(c("cases","tot_cases","total_cases","new_case"))), dplyr::coalesce)))
) |>
dplyr::arrange(state, date)
head(cases)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
cases <- request(api) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform() |>
resp_check_status() |>
resp_body_json(simplifyVector = TRUE) |>
tibble::as_tibble() |>
dplyr::transmute(
state = state,
date  = as.Date(end_date),                       # ISO-8601 Date
cases = suppressWarnings(as.numeric(new_cases))  # numeric
) |>
dplyr::filter(
state %in% c(state.abb, "DC", "PR"),
!is.na(date), !is.na(cases)
) |>
dplyr::arrange(state, date)
head(cases)
api <- "https://data.cdc.gov/resource/pwn4-m3yp.json"
cases <- request(api) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform() |>
resp_check_status() |>
resp_body_json(simplifyVector = TRUE) |>
tibble::as_tibble() |>
dplyr::transmute(
state = state,
date  = as.Date(end_date),                       # ISO-8601 Date
cases = suppressWarnings(as.numeric(new_cases))  # numeric
) |>
dplyr::filter(
state %in% c(state.abb, "DC", "PR"),
!is.na(date), !is.na(cases)
)
head(cases)
library(lubridate)
cases %>%
filter(date >= as.Date("2020-01-01"), date <= as.Date("2021-12-31")) %>%
left_join(
population %>% select(state, state_name, pop_2020, pop_2021, region_name),
by = "state"
) %>%
mutate(
pop = if_else(year(date) == 2020, pop_2020, pop_2021),
cases_per_100k = 1e5 * as.numeric(cases) / pop
) %>%
ggplot(aes(x = date, y = cases_per_100k, group = state, color = state)) +
geom_line(alpha = 0.5, linewidth = 0.25) +
facet_wrap(~ region_name, ncol = 2, scales = "free_y") +
guides(color = "none") +
labs(
title = "COVID-19 Cases per 100,000 by State (2020–2021)",
subtitle = "Stratified by CDC PHS Region",
x = "Date",
y = "Cases per 100,000",
caption = "Sources: CDC (pwn4-m3yp) and US Census PEP"
)
library(lubridate)
cases |>
filter(date >= as.Date("2020-01-01"), date <= as.Date("2021-12-31")) %>%
left_join(
population |> select(state, state_name, pop_2020, pop_2021, region_name),
by = "state"
) |>
mutate(
pop = if_else(year(date) == 2020, pop_2020, pop_2021),
cases_per_100k = 1e5 * as.numeric(cases) / pop
) |>
ggplot(aes(x = date, y = cases_per_100k, group = state, color = state)) +
geom_line(alpha = 0.5, linewidth = 0.25) +
facet_wrap(~ region_name, ncol = 2, scales = "free_y") +
guides(color = "none") +
labs(
title = "COVID-19 Cases per 100,000 by State (2020–2021)",
subtitle = "Stratified by CDC PHS Region",
x = "Date",
y = "Cases per 100,000",
caption = "Sources: CDC (pwn4-m3yp) and US Census PEP"
)
library(lubridate)
cases |>
filter(date >= as.Date("2020-01-01"), date <= as.Date("2021-12-31")) %>%
left_join(
population |> select(state, state_name, pop_2020, pop_2021, region_name),
by = "state"
) |>
mutate(
pop = if_else(year(date) == 2020, pop_2020, pop_2021),
cases_per_100k = 1e5 * as.numeric(cases) / pop
) |>
ggplot(aes(x = date, y = cases_per_100k, group = state, color = state)) +
geom_line() +
facet_wrap(~ region_name) +
guides(color = "none") +
labs(
title = "COVID-19 Cases per 100,000 by State (2020–2021)",
subtitle = "Stratified by CDC PHS Region",
x = "Date",
y = "Cases per 100,000",
caption = "Sources: CDC (pwn4-m3yp) and US Census PEP"
)
library(lubridate)
cases |>
filter(date >= as.Date("2020-01-01"), date <= as.Date("2021-12-31")) %>%
left_join(
population |> select(state, state_name, pop_2020, pop_2021, region_name),
by = "state"
) |>
mutate(
pop = if_else(year(date) == 2020, pop_2020, pop_2021),
cases_per_100k = 1e5 * as.numeric(cases) / pop
) |>
ggplot(aes(x = date, y = cases_per_100k, group = state, color = state)) +
geom_line() +
facet_wrap(~ region_name, ncol = 2, scales = "free_y") +
guides(color = "none") +
labs(
title = "COVID-19 Cases per 100,000 by State (2020–2021)",
subtitle = "Stratified by CDC PHS Region",
x = "Date",
y = "Cases per 100,000",
caption = "Sources: CDC (pwn4-m3yp) and US Census PEP"
)
library(knitr)
cases_monthly <- cases %>%
mutate(date = if (inherits(date, "Date")) date else ymd(date)) %>%
filter(year(date) %in% c(2020, 2021)) %>%
group_by(
year = year(date),
month_num = month(date),
month = month(date, label = TRUE, abbr = FALSE)
) %>%
summarise(total_cases = sum(as.numeric(cases), na.rm = TRUE), .groups = "drop") %>%
arrange(year, month_num) %>%
select(year, month, total_cases)
kable(cases_monthly, caption = "Total COVID-19 Cases by Month and Year (2020–2021)")
resp <- request(deaths_url) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform()
deaths_url <- "https://data.cdc.gov/resource/9bhg-hcku.json"
resp <- request(deaths_url) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform()
stopifnot(resp_status(resp) == 200,
grepl("json", resp_content_type(resp), ignore.case = TRUE))
raw_deaths <- resp_body_json(resp, simplifyVector = TRUE) |> as_tibble()
# Identify relevant columns robustly
state_col  <- intersect(names(raw_deaths), c("state", "jurisdiction", "state_name"))[1]
date_col   <- intersect(names(raw_deaths), c("end_date", "submission_date", "date", "as_of"))[1]
# Prefer cumulative deaths if present; otherwise fall back to daily/new
deaths_col <- intersect(names(raw_deaths), c("tot_death", "total_deaths", "deaths", "new_death", "new_deaths", "death"))[1]
if (any(is.na(c(state_col, date_col, deaths_col)))) {
stop("Required columns not found in deaths dataset. Columns present: ",
paste(names(raw_deaths), collapse = ", "))
}
# Clean dataset: state, date (Date), deaths (numeric)
deaths <- raw_deaths %>%
transmute(
state  = .data[[state_col]],
date   = as.Date(.data[[date_col]]),
deaths = suppressWarnings(as.numeric(.data[[deaths_col]]))
) %>%
arrange(state, date)
summary(deaths$date)
head(deaths)
resp <- request(deaths_url) |>
req_url_query(`$limit` = 10000000000) |>
req_user_agent("bst260-pset04/1.0") |>
req_perform()
stopifnot(resp_status(resp) == 200,
grepl("json", resp_content_type(resp), ignore.case = TRUE))
raw_deaths <- resp_body_json(resp, simplifyVector = TRUE) |> as_tibble()
# Identify relevant columns robustly
state_col  <- intersect(names(raw_deaths), c("state", "jurisdiction", "state_name"))[1]
date_col   <- intersect(names(raw_deaths), c("end_date", "submission_date", "date", "as_of"))[1]
# Prefer cumulative deaths if present; otherwise fall back to daily/new
deaths_col <- intersect(names(raw_deaths), c("tot_death", "total_deaths", "deaths", "new_death", "new_deaths", "death"))[1]
if (any(is.na(c(state_col, date_col, deaths_col)))) {
stop("Required columns not found in deaths dataset. Columns present: ",
paste(names(raw_deaths), collapse = ", "))
}
# Clean dataset: state, date (Date), deaths (numeric)
deaths <- raw_deaths |>
transmute(
state  = .data[[state_col]],
date   = as.Date(.data[[date_col]]),
deaths = suppressWarnings(as.numeric(.data[[deaths_col]]))
)
head(deaths)
# Clean dataset: state, date (Date), deaths (numeric)
deaths <- raw_deaths |> as_tibble(deaths_raw) |> mutate(state = state, date =as.Date(end_date), deaths = as.numeric(covid_19_deaths)) |>select(state, date, deaths) |> filter(state %in% population$state_name,!is.na(deaths),!is.na(date))
# Clean dataset: state, date (Date), deaths (numeric)
deaths <- raw_deaths |> as_tibble(raw_deaths) |> mutate(state = state, date =as.Date(end_date), deaths = as.numeric(covid_19_deaths)) |>select(state, date, deaths) |> filter(state %in% population$state_name,!is.na(deaths),!is.na(date))
# Clean dataset: state, date (Date), deaths (numeric)
deaths <- raw_deaths |> mutate(state = state, date =as.Date(end_date), deaths = as.numeric(covid_19_deaths)) |>select(state, date, deaths) |> filter(state %in% population$state_name,!is.na(deaths),!is.na(date))
head(deaths)
"United States" %in% deaths$state
head(deaths)
# Sum deaths by state, keep top 10
top10_deaths <- deaths %>%
group_by(state) %>%
summarise(total_deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
arrange(desc(total_deaths)) %>%
slice_head(n = 10)
# Bar plot (highest to lowest)
ggplot(top10_deaths, aes(x = reorder(state, total_deaths), y = total_deaths)) +
geom_col() +
coord_flip() +
scale_y_continuous(labels = scales::label_comma()) +
labs(
title = "Top 10 States by Total COVID-19 Deaths",
x = "State",
y = "Total deaths",
caption = "Source: CDC (9bhg-hcku)"
)
# Sum deaths by state, keep top 10
top10_deaths <- deaths |> group_by(state) |> summarise(total_deaths = sum(deaths, na.rm = TRUE), .groups = "drop")|> arrange(desc(total_deaths)) |> slice_head(n = 10)
# Bar plot (highest to lowest)
ggplot(top10_deaths, aes(x = reorder(state, total_deaths), y = total_deaths)) +
geom_col() +
coord_flip() +geom_text(aes(label = scales::comma(total_deaths)),
hjust = 1.1) +
scale_y_continuous(labels = scales::label_comma()) +
labs(
title = "Top 10 States by Total COVID-19 Deaths",
x = "State",
y = "Total deaths",
caption = "Source: CDC (9bhg-hcku)"
)
printf "census-key.R\n.Rhistory\n.RData\n.Rproj.user\n.DS_Store\n" >> .gitignore
